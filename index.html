<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Al-Iman Noja - Programmes & Events Calendar</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* ===== CSS RESET & BASE STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary-color: #6a11cb;
            --secondary-color: #2575fc;
            --success-color: #2e7d32;
            --error-color: #c62828;
            --warning-color: #ff9800;
            --text-color: #333;
            --light-bg: #f8f9fa;
            --card-shadow: 0 4px 12px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }

        body {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: var(--text-color);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* ===== LOCATION BANNER ===== */
        .location-banner {
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            font-size: 14px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .location-info {
            display: flex;
            gap: 20px;
        }

        /* ===== WELCOME PAGE ===== */
        .welcome-page {
            background: white;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: var(--card-shadow);
            display: none;
            position: relative;
            overflow: hidden;
        }

        .welcome-header {
            margin-bottom: 30px;
            position: relative;
        }

        .welcome-header::after {
            content: '';
            display: block;
            width: 100px;
            height: 4px;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            margin: 15px auto;
            border-radius: 2px;
        }

        .welcome-message {
            background: var(--light-bg);
            padding: 30px;
            border-radius: 10px;
            margin: 25px 0;
            border-left: 4px solid var(--primary-color);
            text-align: left;
            position: relative;
        }

        .typing-container {
            min-height: 200px;
        }

        .typing-line {
            margin-bottom: 15px;
            min-height: 24px;
        }

        .cursor {
            display: inline-block;
            width: 8px;
            height: 20px;
            background-color: var(--primary-color);
            margin-left: 4px;
            animation: blink 1s infinite;
            vertical-align: middle;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .bold {
            font-weight: bold;
        }

        .italic {
            font-style: italic;
        }

        .highlight {
            color: var(--primary-color);
            font-weight: bold;
        }

        .footer-note {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            color: #666;
            font-style: italic;
        }

        .countdown {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--primary-color);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* ===== LOGIN MODAL ===== */
        .login-modal {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .login-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .login-input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: var(--transition);
        }

        .login-input:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(106, 17, 203, 0.2);
        }

        .login-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            transition: var(--transition);
            font-weight: 600;
        }

        .login-btn:hover {
            background: #5a0db5;
        }

        /* ===== HEADER & USER INFO ===== */
        header {
            text-align: center;
            margin-bottom: 20px;
            color: white;
            padding: 20px;
        }

        header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .user-banner {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* ===== ACTION BUTTONS ===== */
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
        }

        .action-btn-large {
            background: #fff;
            color: var(--primary-color);
            border: none;
            padding: 12px 18px;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .action-btn-large:hover {
            background: #f0f0f0;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        /* ===== TABS ===== */
        .tabs {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 20px;
            background: white;
            border-radius: 12px;
            padding: 5px;
            box-shadow: var(--card-shadow);
        }

        .tab {
            padding: 12px 15px;
            cursor: pointer;
            border-radius: 8px;
            flex: 1;
            min-width: 120px;
            text-align: center;
            transition: var(--transition);
            font-weight: 600;
        }

        .tab.active {
            background: var(--primary-color);
            color: white;
        }

        /* ===== CONTENT SECTIONS ===== */
        .content {
            display: none;
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--card-shadow);
        }

        .content.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ===== WEEK DAYS ===== */
        .week-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .day {
            padding: 12px 5px;
            text-align: center;
            background: #f5f7ff;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            font-size: 14px;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .day.active {
            background: var(--primary-color);
            color: white;
        }

        .day:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        /* ===== EVENTS LIST ===== */
        .events-list {
            display: grid;
            gap: 15px;
        }

        .event-card {
            background: #f8faff;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid var(--primary-color);
            position: relative;
            padding-bottom: 70px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: var(--transition);
        }

        .event-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .event-actions {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 8px;
        }

        .action-btn {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #ddd;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 6px;
            font-size: 12px;
            transition: var(--transition);
            font-weight: 600;
        }

        .edit-btn {
            background: #2196F3;
            color: white;
            border: 1px solid #1976D2;
        }

        .edit-btn:hover {
            background: #1976D2;
        }

        .delete-btn {
            background: #ff4444;
            color: white;
            border: 1px solid #cc0000;
        }

        .delete-btn:hover {
            background: #cc0000;
        }

        .action-btn:hover {
            transform: translateY(-1px);
        }

        .no-events {
            text-align: center;
            padding: 40px;
            color: #888;
            font-style: italic;
        }

        /* ===== FORMS ===== */
        button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
        }

        button:hover {
            background: #5a0db5;
        }

        input, textarea, select {
            width: 100%;
            padding: 14px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: var(--transition);
        }

        input:focus, textarea:focus, select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(106, 17, 203, 0.2);
        }

        /* ===== ACTIVITY LOG ===== */
        .activity-log {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            display: none;
            box-shadow: var(--card-shadow);
        }

        .log-entry {
            padding: 10px 15px;
            margin-bottom: 10px;
            background: var(--light-bg);
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
            font-size: 14px;
        }

        .log-meta {
            color: #666;
            font-size: 12px;
            margin-top: 5px;
        }

        /* ===== FORM ELEMENTS ===== */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #444;
        }

        .day-option {
            padding: 12px;
            text-align: center;
            background: #f5f7ff;
            border-radius: 6px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
        }

        .day-option:hover {
            background: #e6e9ff;
        }

        .day-option.selected {
            background: var(--primary-color);
            color: white;
        }

        .day-option.daily {
            grid-column: 1 / -1;
            background: #ffeb3b;
            font-weight: bold;
        }

        .day-option.daily:hover {
            background: #fdd835;
        }

        .day-option.daily.selected {
            background: #ffc107;
        }

        /* ===== SYNC STATUS ===== */
        .sync-status {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 8px;
            font-size: 14px;
        }

        .sync-success {
            background: #e8f5e9;
            color: var(--success-color);
            border: 1px solid #c8e6c9;
        }

        .sync-error {
            background: #ffebee;
            color: var(--error-color);
            border: 1px solid #ffcdd2;
        }

        .date-range {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 768px) {
            .welcome-page {
                padding: 20px;
            }
            
            .welcome-message {
                padding: 20px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .week-days {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .date-range {
                grid-template-columns: 1fr;
            }
            
            .location-banner {
                flex-direction: column;
                gap: 10px;
            }
            
            .location-info {
                flex-direction: column;
                gap: 5px;
            }
            
            .day[data-day="mon"]::after { content: "Mon"; }
            .day[data-day="tue"]::after { content: "Tue"; }
            .day[data-day="wed"]::after { content: "Wed"; }
            .day[data-day="thu"]::after { content: "Thu"; }
            .day[data-day="fri"]::after { content: "Fri"; }
            .day[data-day="sat"]::after { content: "Sat"; }
            .day[data-day="sun"]::after { content: "Sun"; }
            
            .day {
                font-size: 11px;
                padding: 8px 2px;
            }
            
            .day span {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Welcome Page -->
    <div class="welcome-page" id="welcome-page">
        <div class="countdown" id="countdown">5</div>
        <div class="welcome-header">
            <i class="fas fa-hands-helping" style="font-size: 48px; color: #6a11cb; margin-bottom: 20px;"></i>
            <h2>Welcome to Al-Iman Noja Operations System</h2>
        </div>
        
        <div class="welcome-message">
            <div class="typing-container" id="typing-container">
                <!-- Typing content will be inserted here by JavaScript -->
            </div>
        </div>
        
        <div class="footer-note">
            <small>Proudly maintained by those who keep your spaces clean and functional</small>
        </div>
    </div>

    <!-- Location and Time Banner -->
    <div class="location-banner">
        <div class="location-info">
            <div><i class="fas fa-map-marker-alt"></i> Location: <span id="user-location">Detecting...</span></div>
            <div><i class="fas fa-clock"></i> Current Time: <span id="current-time">Loading...</span></div>
        </div>
        <div id="user-status">Not logged in</div>
    </div>

    <!-- Login Modal -->
    <div class="login-modal" id="login-modal">
        <div class="login-content">
            <h2><i class="fas fa-lock"></i> Login Required</h2>
            <input type="text" id="username" class="login-input" placeholder="Username">
            <input type="password" id="password" class="login-input" placeholder="Password">
            <button class="login-btn" onclick="checkLogin()">Login</button>
            <div style="color: red; margin-top: 10px; display: none;" id="login-error">Invalid username or password</div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container" id="main-content" style="display: none;">
        <header>
            <h1>Programmes & Events Calendar</h1>
            <div class="user-banner">
                <i class="fas fa-user"></i> 
                Logged in as: <span id="logged-in-user">User</span>
                <span id="supabase-status" style="margin-left: 15px; font-size: 12px; background: #ff9800; padding: 2px 8px; border-radius: 10px;">Checking Supabase...</span>
            </div>
        </header>

        <!-- Sync Status -->
        <div class="sync-status" id="sync-status" style="display: none;"></div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="action-btn-large" onclick="printPage()">
                <i class="fas fa-print"></i> Print
            </button>
            <button class="action-btn-large" onclick="downloadCSV()">
                <i class="fas fa-download"></i> Download CSV
            </button>
            <button class="action-btn-large" onclick="syncData()">
                <i class="fas fa-sync"></i> Sync Data
            </button>
            <button class="action-btn-large" onclick="viewActivityLog()">
                <i class="fas fa-history"></i> View Logs
            </button>
            <button class="action-btn-large" onclick="clearAllLogs()" style="background: #ff9800;">
                <i class="fas fa-trash-alt"></i> Clear Logs
            </button>
            <button class="action-btn-large" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
        
        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active" data-tab="view">View Schedule</div>
            <div class="tab" data-tab="add-programme">Add Programme</div>
            <div class="tab" data-tab="add-event">Add Event</div>
            <div class="tab" data-tab="manage">Manage All</div>
        </div>
        
        <!-- View Schedule Tab -->
        <div class="content active" id="view">
            <h2>Weekly Schedule</h2>
            <div class="week-days">
                <div class="day active" data-day="mon"><span>Monday</span></div>
                <div class="day" data-day="tue"><span>Tuesday</span></div>
                <div class="day" data-day="wed"><span>Wednesday</span></div>
                <div class="day" data-day="thu"><span>Thursday</span></div>
                <div class="day" data-day="fri"><span>Friday</span></div>
                <div class="day" data-day="sat"><span>Saturday</span></div>
                <div class="day" data-day="sun"><span>Sunday</span></div>
            </div>
            
            <div class="events-container">
                <h3>Schedule for <span id="current-day">Monday</span></h3>
                <div class="events-list" id="programmes-list">
                    <div class="no-events">Loading programmes...</div>
                </div>
            </div>
        </div>
        
        <!-- Add Programme Tab -->
        <div class="content" id="add-programme">
            <h2>Add New Programme</h2>
            <form id="programme-form">
                <div class="form-group">
                    <label for="programme-title">Programme Title</label>
                    <input type="text" id="programme-title" placeholder="e.g., Madrasah Class" required>
                </div>
                
                <div class="form-group">
                    <label for="programme-description">Description</label>
                    <textarea id="programme-description" placeholder="Describe the programme..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>Programme Days</label>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 10px 0;">
                        <div class="day-option" data-day="mon">Monday</div>
                        <div class="day-option" data-day="tue">Tuesday</div>
                        <div class="day-option" data-day="wed">Wednesday</div>
                        <div class="day-option" data-day="thu">Thursday</div>
                        <div class="day-option" data-day="fri">Friday</div>
                        <div class="day-option" data-day="sat">Saturday</div>
                        <div class="day-option" data-day="sun">Sunday</div>
                        <div class="day-option daily">DAILY (All Days)</div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="programme-start-time">Start Time</label>
                        <input type="time" id="programme-start-time" required>
                    </div>
                    <div class="form-group">
                        <label for="programme-end-time">End Time</label>
                        <input type="time" id="programme-end-time" required>
                    </div>
                </div>
                
                <button type="submit"><i class="fas fa-calendar-plus"></i> Add Programme</button>
            </form>
        </div>
        
        <!-- Add Event Tab -->
        <div class="content" id="add-event">
            <h2>Add New Event</h2>
            <form id="event-form">
                <div class="form-group">
                    <label for="event-title">Event Title</label>
                    <input type="text" id="event-title" placeholder="e.g., Food Sale" required>
                </div>
                
                <div class="form-group">
                    <label>Event Date Range</label>
                    <div class="date-range">
                        <div class="form-group">
                            <label for="event-start-date">Start Date</label>
                            <input type="date" id="event-start-date" required>
                        </div>
                        <div class="form-group">
                            <label for="event-end-date">End Date</label>
                            <input type="date" id="event-end-date" required>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="event-description">Description</label>
                    <textarea id="event-description" placeholder="Describe the event..."></textarea>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="event-start-time">Start Time</label>
                        <input type="time" id="event-start-time" required>
                    </div>
                    <div class="form-group">
                        <label for="event-end-time">End Time</label>
                        <input type="time" id="event-end-time" required>
                    </div>
                </div>
                
                <button type="submit"><i class="fas fa-plus-circle"></i> Add Event</button>
            </form>
        </div>
        
        <!-- Manage All Tab -->
        <div class="content" id="manage">
            <h2>Manage All Programmes & Events</h2>
            <div class="events-list" id="manage-list">
                <div class="no-events">Loading data...</div>
            </div>
        </div>

        <!-- Activity Log -->
        <div class="activity-log" id="activity-log">
            <h3>Activity Log <span id="log-count" style="font-size: 14px; color: #666;"></span></h3>
            <div id="log-entries"></div>
        </div>
    </div>

    <script>
        // ===== CONFIGURATION =====
        const CONFIG = {
            SUPABASE_URL: 'https://hbmttwxsgpgrfrcijagt.supabase.co',
            SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhibXR0d3hzZ3BncmZyY2lqYWd0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyMTEyMjcsImV4cCI6MjA3OTc4NzIyN30.LeownHuFwZmFOx7XOBFZYh2VZ9qy9H4fThuuR4WF1I0',
            VALID_USERS: {
                'Admin': '456',
                'Ops': '123'
            }
        };

        // ===== SUPABASE CLIENT =====
        const supabase = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);

        // ===== APPLICATION STATE =====
        const AppState = {
            programmes: {
                mon: [], tue: [], wed: [], thu: [], fri: [], sat: [], sun: []
            },
            events: [],
            currentUser: null,
            selectedDays: [],
            supabaseConnected: false
        };

        // ===== WELCOME MESSAGE CONTENT =====
        const WELCOME_CONTENT = [
            { text: "Work Order for Programmes & Events", class: "bold" },
            { text: "For Internal Use Only", class: "italic" },
            { text: "" },
            { text: "This system was designed, developed, and maintained by the ", class: "" },
            { text: "Al-Iman Noja Operations Team", class: "bold" },
            { text: " ‚Äî the dedicated cleaners and facility maintenance staff of Al-Iman Mosque who work tirelessly behind the scenes.", class: "" },
            { text: "" },
            { text: "Built with modern technology and AI support, it stands as proof that learning has no boundaries.", class: "" },
            { text: "" },
            { text: "All activities are logged to ensure accountability and continuous improvement.", class: "" },
            { text: "" },
            { text: "Every job deserves respect. We may work in sanitation, but we carry dignity, skill, and the same drive to learn and grow as anyone else. No task is too small when performed with sincerity and a big heart.", class: "" }
        ];

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        async function initializeApp() {
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            getUserLocation();
            
            // Test Supabase connection
            await testSupabaseConnection();
            
            console.log("Mosque Operations Calendar System Ready");
        }

        // ===== SUPABASE CONNECTION TEST =====
        async function testSupabaseConnection() {
            const statusElement = document.getElementById('supabase-status');
            
            try {
                // Test connection by trying to fetch logs
                const { data, error } = await supabase
                    .from('activity_logs')
                    .select('count')
                    .limit(1);
                
                if (error) throw error;
                
                AppState.supabaseConnected = true;
                statusElement.textContent = '‚úì Supabase Connected';
                statusElement.style.background = '#4CAF50';
                console.log("Supabase connection successful");
            } catch (error) {
                AppState.supabaseConnected = false;
                statusElement.textContent = '‚úó Supabase Disconnected';
                statusElement.style.background = '#f44336';
                console.error("Supabase connection failed:", error);
            }
        }

        // ===== SUPABASE LOGGING FUNCTIONS =====
        async function saveLogToSupabase(logData) {
            if (!AppState.supabaseConnected) {
                console.warn("Supabase not connected, skipping log save");
                return null;
            }

            try {
                const { data, error } = await supabase
                    .from('activity_logs')
                    .insert([{
                        username: logData.user,
                        action: logData.message,
                        location: logData.location,
                        device_type: logData.deviceType,
                        screen_resolution: logData.screenResolution,
                        browser: logData.browserInfo,
                        user_agent: logData.userAgent
                    }])
                    .select();
                
                if (error) throw error;
                return data ? data[0] : null;
            } catch (error) {
                console.error("Error saving log to Supabase:", error);
                throw error;
            }
        }

        async function loadLogsFromSupabase() {
            if (!AppState.supabaseConnected) {
                console.warn("Supabase not connected, cannot load logs");
                return [];
            }

            try {
                const { data, error } = await supabase
                    .from('activity_logs')
                    .select('*')
                    .order('timestamp', { ascending: false })
                    .limit(100);
                
                if (error) throw error;
                
                if (data && data.length > 0) {
                    return data.map(item => ({
                        id: item.id,
                        timestamp: new Date(item.timestamp).toLocaleString('en-SG'),
                        user: item.username,
                        message: item.action,
                        location: item.location,
                        deviceType: item.device_type,
                        screenResolution: item.screen_resolution,
                        browserInfo: item.browser,
                        ipAddress: item.ip_address,
                        country: item.country,
                        userAgent: item.user_agent
                    }));
                }
                return [];
            } catch (error) {
                console.error("Error loading logs from Supabase:", error);
                return [];
            }
        }

        async function clearLogsFromSupabase() {
            if (!AppState.supabaseConnected) {
                console.warn("Supabase not connected, cannot clear logs");
                return false;
            }

            try {
                const { error } = await supabase
                    .from('activity_logs')
                    .delete()
                    .neq('id', '00000000-0000-0000-0000-000000000000');
                
                if (error) throw error;
                return true;
            } catch (error) {
                console.error("Error clearing logs from Supabase:", error);
                throw error;
            }
        }

        // ===== ACTIVITY LOGGING SYSTEM =====
        async function logActivity(message) {
            const timestamp = new Date().toLocaleString('en-SG');
            const userAgent = navigator.userAgent;
            const location = document.getElementById('user-location').textContent;
            
            const deviceType = getDeviceType(userAgent);
            const screenResolution = `${screen.width}x${screen.height}`;
            const browserInfo = getBrowserInfo(userAgent);
            
            const logEntry = {
                timestamp,
                user: AppState.currentUser,
                message,
                location,
                deviceType,
                screenResolution,
                browserInfo,
                userAgent: userAgent
            };
            
            // Save to Supabase
            try {
                await saveLogToSupabase(logEntry);
                console.log("Activity logged to Supabase:", message);
            } catch (error) {
                console.error("Failed to save log to Supabase:", error);
            }
            
            // Refresh the log display to show the latest entries
            await refreshLogDisplay();
        }

        async function refreshLogDisplay() {
            const logs = await loadLogsFromSupabase();
            updateLogDisplay(logs);
        }

        function updateLogDisplay(logs) {
            const logEntries = document.getElementById('log-entries');
            const logCount = document.getElementById('log-count');
            
            if (logEntries) {
                logEntries.innerHTML = '';
                
                if (logs.length === 0) {
                    logEntries.innerHTML = '<div class="no-events">No activity logs found</div>';
                    logCount.textContent = '(0 logs)';
                    return;
                }
                
                logCount.textContent = `(${logs.length} logs from Supabase)`;
                
                logs.forEach(entry => {
                    const div = document.createElement('div');
                    div.className = 'log-entry';
                    
                    let logText = `<strong>${entry.timestamp}</strong> | ${entry.user} - ${entry.message}`;
                    
                    if (entry.deviceType || entry.location !== 'Detecting...') {
                        logText += `<div class="log-meta">`;
                        logText += `üìç ${entry.location}`;
                        logText += ` | üì± ${entry.deviceType}`;
                        logText += ` | üñ•Ô∏è ${entry.screenResolution}`;
                        logText += ` | üåê ${entry.browserInfo}`;
                        logText += `</div>`;
                    }
                    
                    div.innerHTML = logText;
                    logEntries.appendChild(div);
                });
            }
        }

        async function viewActivityLog() {
            const logContainer = document.getElementById('activity-log');
            const isVisible = logContainer.style.display === 'block';
            
            if (!isVisible) {
                // Load logs from Supabase when opening
                await refreshLogDisplay();
            }
            
            logContainer.style.display = isVisible ? 'none' : 'block';
        }

        async function clearAllLogs() {
            if (confirm('Clear all activity logs from Supabase? This cannot be undone!') && AppState.currentUser === 'Admin') {
                try {
                    await clearLogsFromSupabase();
                    await refreshLogDisplay();
                    showSyncStatus('All logs cleared from Supabase!', 'success');
                    logActivity('Cleared all activity logs from Supabase');
                } catch (error) {
                    showSyncStatus('Error clearing logs from Supabase', 'error');
                    console.error('Clear logs error:', error);
                }
            }
        }

        // ===== UTILITY FUNCTIONS =====
        function typeText(element, text, speed, callback) {
            let i = 0;
            element.innerHTML = '';
            
            function type() {
                if (i < text.length) {
                    element.innerHTML += text.charAt(i);
                    i++;
                    setTimeout(type, speed);
                } else {
                    if (callback) callback();
                }
            }
            
            type();
        }

        function getDayName(dayCode) {
            const dayNames = {
                'mon': 'Monday', 'tue': 'Tuesday', 'wed': 'Wednesday',
                'thu': 'Thursday', 'fri': 'Friday', 'sat': 'Saturday', 'sun': 'Sunday'
            };
            return dayNames[dayCode] || dayCode;
        }

        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return new Date(dateString).toLocaleDateString('en-US', options);
        }

        function getDeviceType(userAgent) {
            if (/Mobile|Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent)) {
                if (/Tablet|iPad/i.test(userAgent)) {
                    return 'Tablet';
                }
                return 'Mobile';
            }
            return 'Desktop';
        }

        function getBrowserInfo(userAgent) {
            if (userAgent.includes('Chrome')) return 'Chrome';
            if (userAgent.includes('Firefox')) return 'Firefox';
            if (userAgent.includes('Safari') && !userAgent.includes('Chrome')) return 'Safari';
            if (userAgent.includes('Edge')) return 'Edge';
            if (userAgent.includes('Opera')) return 'Opera';
            return 'Unknown Browser';
        }

        // ===== WELCOME PAGE FUNCTIONS =====
        function typeWelcomeMessage() {
            const container = document.getElementById('typing-container');
            container.innerHTML = '';
            
            let lineIndex = 0;
            let totalLines = WELCOME_CONTENT.length;
            
            function typeNextLine() {
                if (lineIndex < totalLines) {
                    const lineData = WELCOME_CONTENT[lineIndex];
                    
                    // Create a new line element
                    const lineElement = document.createElement('div');
                    lineElement.className = `typing-line ${lineData.class}`;
                    container.appendChild(lineElement);
                    
                    // If it's an empty line, just add a line break and move to next
                    if (lineData.text === "") {
                        lineIndex++;
                        setTimeout(typeNextLine, 300);
                        return;
                    }
                    
                    // Type the text with cursor
                    const textElement = document.createElement('span');
                    lineElement.appendChild(textElement);
                    
                    const cursor = document.createElement('span');
                    cursor.className = 'cursor';
                    lineElement.appendChild(cursor);
                    
                    typeText(textElement, lineData.text, 30, function() {
                        // Remove cursor after typing is done
                        lineElement.removeChild(cursor);
                        lineIndex++;
                        
                        // Add a slight delay between lines
                        setTimeout(typeNextLine, 500);
                    });
                } else {
                    // Start countdown when typing is complete
                    startCountdown();
                }
            }
            
            typeNextLine();
        }

        function startCountdown() {
            let countdownValue = 5;
            const countdownElement = document.getElementById('countdown');
            countdownElement.textContent = countdownValue;
            
            const countdownInterval = setInterval(() => {
                countdownValue--;
                countdownElement.textContent = countdownValue;
                
                if (countdownValue <= 0) {
                    clearInterval(countdownInterval);
                    hideWelcomePage();
                }
            }, 1000);
        }

        function showWelcomePage() {
            document.getElementById('welcome-page').style.display = 'block';
            document.getElementById('main-content').style.display = 'none';
            typeWelcomeMessage();
        }

        function hideWelcomePage() {
            document.getElementById('welcome-page').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
        }

        // ===== AUTHENTICATION =====
        function checkLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorElement = document.getElementById('login-error');

            if (CONFIG.VALID_USERS[username] && CONFIG.VALID_USERS[username] === password) {
                AppState.currentUser = username;
                document.getElementById('login-modal').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                document.getElementById('logged-in-user').textContent = username;
                document.getElementById('user-status').innerHTML = `<i class="fas fa-user"></i> Logged in as: ${username}`;
                logActivity(`Logged in as ${username}`);
                showWelcomePage();
                initializeCalendar();
            } else {
                errorElement.style.display = 'block';
            }
        }

        function logout() {
            logActivity('Logged out');
            AppState.currentUser = null;
            document.getElementById('login-modal').style.display = 'flex';
            document.getElementById('main-content').style.display = 'none';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('login-error').style.display = 'none';
            document.getElementById('user-status').textContent = 'Not logged in';
        }

        // ===== LOCATION & TIME FUNCTIONS =====
        function getUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        try {
                            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                            const data = await response.json();
                            
                            if (data.address) {
                                const street = data.address.road || '';
                                const city = data.address.city || data.address.town || '';
                                
                                let locationText = 'Singapore';
                                if (street) locationText = `${street}, ${city}`;
                                
                                document.getElementById('user-location').textContent = locationText;
                            }
                        } catch (error) {
                            console.log("Couldn't get street name, using city only");
                            document.getElementById('user-location').textContent = 'Singapore';
                        }
                    },
                    (error) => {
                        console.log("Location access denied or unavailable");
                        document.getElementById('user-location').textContent = 'Singapore';
                    }
                );
            } else {
                document.getElementById('user-location').textContent = 'Singapore';
            }
        }

        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleString('en-SG', { 
                timeZone: 'Asia/Singapore',
                weekday: 'short', 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit',
                hour12: false
            });
            document.getElementById('current-time').textContent = timeString;
        }

        // ===== CALENDAR FUNCTIONS =====
        function initializeCalendar() {
            setupUI();
        }

        function setupUI() {
            setupDaySelection();
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(tabId).classList.add('active');
                    
                    if (tabId === 'manage') {
                        displayManageList();
                    } else if (tabId === 'view') {
                        displaySchedule(getCurrentDay());
                    }
                });
            });

            document.querySelectorAll('.day').forEach(day => {
                day.addEventListener('click', () => {
                    const dayId = day.getAttribute('data-day');
                    document.querySelectorAll('.day').forEach(d => d.classList.remove('active'));
                    day.classList.add('active');
                    document.getElementById('current-day').textContent = day.textContent;
                    displaySchedule(dayId);
                });
            });

            document.getElementById('programme-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                if (AppState.currentUser !== 'Admin') {
                    alert('Only Admin can add programmes');
                    return;
                }

                const title = document.getElementById('programme-title').value;
                const description = document.getElementById('programme-description').value;
                const startTime = document.getElementById('programme-start-time').value;
                const endTime = document.getElementById('programme-end-time').value;
                
                const daysToAdd = AppState.selectedDays.length > 0 ? AppState.selectedDays : ['mon'];
                
                daysToAdd.forEach(day => {
                    AppState.programmes[day].push({ 
                        title, 
                        description, 
                        startTime, 
                        endTime, 
                        days: daysToAdd
                    });
                });
                
                this.reset();
                AppState.selectedDays = [];
                document.querySelectorAll('.day-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                
                logActivity(`Added programme: "${title}"`);
                showSyncStatus(`Programme added to ${daysToAdd.map(d => getDayName(d)).join(', ')}!`, 'success');
                
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
                document.querySelector('.tab[data-tab="view"]').classList.add('active');
                document.getElementById('view').classList.add('active');
                displaySchedule('mon');
            });

            document.getElementById('event-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                if (AppState.currentUser !== 'Admin') {
                    alert('Only Admin can add events');
                    return;
                }

                const title = document.getElementById('event-title').value;
                const startDate = document.getElementById('event-start-date').value;
                const endDate = document.getElementById('event-end-date').value;
                const description = document.getElementById('event-description').value;
                const startTime = document.getElementById('event-start-time').value;
                const endTime = document.getElementById('event-end-time').value;
                
                if (new Date(endDate) < new Date(startDate)) {
                    alert('End date cannot be before start date!');
                    return;
                }
                
                AppState.events.push({
                    title,
                    description,
                    startDate,
                    endDate,
                    startTime,
                    endTime
                });
                
                this.reset();
                logActivity(`Added event: "${title}"`);
                showSyncStatus('Event added successfully!', 'success');
                
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
                document.querySelector('.tab[data-tab="view"]').classList.add('active');
                document.getElementById('view').classList.add('active');
                displaySchedule(getCurrentDay());
            });

            const today = new Date().toISOString().split('T')[0];
            document.getElementById('event-start-date').min = today;
            document.getElementById('event-end-date').min = today;

            displaySchedule('mon');
        }

        function setupDaySelection() {
            document.querySelectorAll('.day-option').forEach(option => {
                option.addEventListener('click', function() {
                    const day = this.getAttribute('data-day');
                    
                    if (this.classList.contains('daily')) {
                        AppState.selectedDays = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
                        document.querySelectorAll('.day-option').forEach(opt => {
                            opt.classList.add('selected');
                        });
                    } else {
                        if (AppState.selectedDays.includes(day)) {
                            AppState.selectedDays = AppState.selectedDays.filter(d => d !== day);
                            this.classList.remove('selected');
                        } else {
                            AppState.selectedDays.push(day);
                            this.classList.add('selected');
                        }
                        
                        const allDays = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
                        const dailyOption = document.querySelector('.day-option.daily');
                        if (allDays.every(day => AppState.selectedDays.includes(day))) {
                            dailyOption.classList.add('selected');
                        } else {
                            dailyOption.classList.remove('selected');
                        }
                    }
                });
            });
        }

        function displaySchedule(day = 'mon') {
            const programmesList = document.getElementById('programmes-list');
            programmesList.innerHTML = '';

            if (AppState.programmes[day] && AppState.programmes[day].length > 0) {
                AppState.programmes[day].forEach((programme, index) => {
                    const card = document.createElement('div');
                    card.className = 'event-card';
                    card.innerHTML = `
                        <div style="font-weight: bold; font-size: 18px;">${programme.title}</div>
                        <div style="color: #6a11cb; margin: 5px 0;">${programme.startTime} - ${programme.endTime}</div>
                        <div>${programme.description}</div>
                        ${AppState.currentUser === 'Admin' ? `
                        <div class="event-actions">
                            <button class="action-btn edit-btn" onclick="editProgramme('${day}', ${index})">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="action-btn delete-btn" onclick="deleteProgramme('${day}', ${index})">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                        ` : ''}
                    `;
                    programmesList.appendChild(card);
                });
            } else {
                programmesList.innerHTML = '<div class="no-events">No programmes scheduled</div>';
            }
        }

        function displayManageList() {
            const manageList = document.getElementById('manage-list');
            manageList.innerHTML = '';

            let hasItems = false;

            Object.keys(AppState.programmes).forEach(day => {
                if (AppState.programmes[day].length > 0) {
                    hasItems = true;
                    AppState.programmes[day].forEach((programme, index) => {
                        const card = document.createElement('div');
                        card.className = 'event-card';
                        card.innerHTML = `
                            <div style="font-weight: bold;">${programme.title} (${getDayName(day)})</div>
                            <div style="color: #6a11cb;">${programme.startTime} - ${programme.endTime}</div>
                            <div>${programme.description}</div>
                            <div class="event-actions">
                                <button class="action-btn edit-btn" onclick="editProgramme('${day}', ${index})">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="action-btn delete-btn" onclick="deleteProgramme('${day}', ${index})">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        `;
                        manageList.appendChild(card);
                    });
                }
            });

            if (AppState.events.length > 0) {
                hasItems = true;
                AppState.events.forEach((event, index) => {
                    const card = document.createElement('div');
                    card.className = 'event-card';
                    const dateDisplay = event.startDate === event.endDate ? 
                        formatDate(event.startDate) : 
                        `${formatDate(event.startDate)} - ${formatDate(event.endDate)}`;
                    
                    card.innerHTML = `
                        <div style="font-weight: bold;">${event.title} (Event)</div>
                        <div style="color: #6a11cb;">${dateDisplay} | ${event.startTime} - ${event.endTime}</div>
                        <div>${event.description}</div>
                        <div class="event-actions">
                            <button class="action-btn edit-btn" onclick="editEvent(${index})">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="action-btn delete-btn" onclick="deleteEvent(${index})">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    `;
                    manageList.appendChild(card);
                });
            }

            if (!hasItems) {
                manageList.innerHTML = '<div class="no-events">No programmes or events to manage</div>';
            }
        }

        // ===== PROGRAMME & EVENT MANAGEMENT =====
        function deleteProgramme(day, index) {
            if (confirm('Delete this programme?')) {
                const programme = AppState.programmes[day][index];
                const programmeTitle = programme.title;
                
                AppState.programmes[day].splice(index, 1);
                
                if (programme.days && programme.days.length > 1) {
                    programme.days.forEach(d => {
                        if (d !== day) {
                            const idx = AppState.programmes[d].findIndex(p => p.title === programme.title);
                            if (idx !== -1) {
                                AppState.programmes[d].splice(idx, 1);
                            }
                        }
                    });
                }
                
                displayManageList();
                if (document.getElementById('view').classList.contains('active')) {
                    displaySchedule(getCurrentDay());
                }
                logActivity(`Deleted programme: "${programmeTitle}"`);
                showSyncStatus('Programme deleted successfully!', 'success');
            }
        }

        function deleteEvent(index) {
            if (confirm('Delete this event?')) {
                const event = AppState.events[index];
                const eventTitle = event.title;
                
                AppState.events.splice(index, 1);
                displayManageList();
                logActivity(`Deleted event: "${eventTitle}"`);
                showSyncStatus('Event deleted successfully!', 'success');
            }
        }

        function editProgramme(day, index) {
            if (confirm('Edit this programme? It will be deleted and you can re-add it with changes.')) {
                const programme = AppState.programmes[day][index];
                document.getElementById('programme-title').value = programme.title;
                document.getElementById('programme-description').value = programme.description;
                document.getElementById('programme-start-time').value = programme.startTime;
                document.getElementById('programme-end-time').value = programme.endTime;
                
                AppState.selectedDays = programme.days || [day];
                document.querySelectorAll('.day-option').forEach(opt => {
                    const optDay = opt.getAttribute('data-day');
                    if (AppState.selectedDays.includes(optDay)) {
                        opt.classList.add('selected');
                    } else {
                        opt.classList.remove('selected');
                    }
                });
                
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
                document.querySelector('.tab[data-tab="add-programme"]').classList.add('active');
                document.getElementById('add-programme').classList.add('active');
                
                deleteProgramme(day, index);
                logActivity(`Editing programme: "${programme.title}"`);
            }
        }

        function editEvent(index) {
            if (confirm('Edit this event? It will be deleted and you can re-add it with changes.')) {
                const event = AppState.events[index];
                document.getElementById('event-title').value = event.title;
                document.getElementById('event-start-date').value = event.startDate;
                document.getElementById('event-end-date').value = event.endDate;
                document.getElementById('event-description').value = event.description;
                document.getElementById('event-start-time').value = event.startTime;
                document.getElementById('event-end-time').value = event.endTime;
                
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
                document.querySelector('.tab[data-tab="add-event"]').classList.add('active');
                document.getElementById('add-event').classList.add('active');
                
                deleteEvent(index);
                logActivity(`Editing event: "${event.title}"`);
            }
        }

        function getCurrentDay() {
            const activeDay = document.querySelector('.day.active');
            return activeDay ? activeDay.getAttribute('data-day') : 'mon';
        }

        // ===== DATA MANAGEMENT =====
        function showSyncStatus(message, type) {
            const statusElement = document.getElementById('sync-status');
            statusElement.textContent = message;
            statusElement.className = 'sync-status';
            
            if (type === 'success') {
                statusElement.classList.add('sync-success');
            } else if (type === 'error') {
                statusElement.classList.add('sync-error');
            }
            
            statusElement.style.display = 'block';
            
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 5000);
        }

        function syncData() {
            showSyncStatus('Data synced successfully!', 'success');
            logActivity('Manually synced data');
        }

        function downloadCSV() {
            let csvContent = "Type,Title,Description,Day,Start Date,End Date,Start Time,End Time,Days\n";
            
            Object.keys(AppState.programmes).forEach(day => {
                AppState.programmes[day].forEach(programme => {
                    const row = [
                        "Programme",
                        `"${programme.title}"`,
                        `"${programme.description}"`,
                        day,
                        "",
                        "",
                        programme.startTime,
                        programme.endTime,
                        programme.days ? programme.days.join(',') : day
                    ];
                    csvContent += row.join(',') + '\n';
                });
            });
            
            AppState.events.forEach(event => {
                const row = [
                    "Event",
                    `"${event.title}"`,
                    `"${event.description}"`,
                    "",
                    event.startDate,
                    event.endDate,
                    event.startTime,
                    event.endTime,
                    ""
                ];
                csvContent += row.join(',') + '\n';
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'programmes-events.csv';
            link.click();
            
            logActivity('Downloaded data as CSV');
            showSyncStatus('CSV downloaded successfully!', 'success');
        }

        function printPage() {
            window.print();
            logActivity('Printed calendar');
        }
    </script>
</body>
</html>