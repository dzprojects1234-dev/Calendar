<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Programmes & Events Calendar</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* [KEEP ALL YOUR EXISTING CSS STYLES] */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .singapore-time {
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            text-align: center;
            font-size: 14px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        /* [INCLUDE ALL YOUR OTHER CSS STYLES HERE] */
        
    </style>
</head>
<body>
    <!-- [KEEP ALL YOUR EXISTING HTML STRUCTURE] -->
    <!-- Singapore Time Display -->
    <div class="singapore-time">
        <i class="fas fa-clock"></i> Singapore: 
        <span id="singapore-time">Loading...</span>
    </div>

    <!-- Login Modal -->
    <div class="login-modal" id="login-modal">
        <div class="login-content">
            <h2><i class="fas fa-lock"></i> Login Required</h2>
            <input type="text" id="username" class="login-input" placeholder="Username">
            <input type="password" id="password" class="login-input" placeholder="Password">
            <button class="login-btn" onclick="checkLogin()">Login</button>
            <div style="color: red; margin-top: 10px; display: none;" id="login-error">Invalid username or password</div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container" id="main-content" style="display: none;">
        <header>
            <h1>Programmes & Events Calendar</h1>
            <div class="user-banner">
                <i class="fas fa-user"></i> 
                Logged in as: <span id="logged-in-user">User</span>
            </div>
        </header>

        <!-- Sync Status -->
        <div class="sync-status" id="sync-status" style="display: none;"></div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="action-btn-large" onclick="printPage()">
                <i class="fas fa-print"></i> Print
            </button>
            <button class="action-btn-large" onclick="exportToCSV()">
                <i class="fas fa-download"></i> Export CSV
            </button>
            <button class="action-btn-large" onclick="manualSync()">
                <i class="fas fa-sync"></i> Sync Data
            </button>
            <button class="action-btn-large" onclick="viewActivityLog()">
                <i class="fas fa-history"></i> View Logs
            </button>
            <button class="action-btn-large" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
        
        <!-- [KEEP ALL YOUR EXISTING TAB STRUCTURE] -->
        <!-- Tabs, content areas, etc. -->
        
    </div>

    <script>
        // === GITHUB CONFIGURATION ===
        // REPLACE WITH YOUR ACTUAL REPOSITORY
        const GITHUB_REPO = 'your-username/your-repo-name'; // e.g., 'johnsmith/calendar'
        const DATA_FILE_PATH = 'data.json';

        // === CALENDAR DATA ===
        let programmes = {
            mon: [], tue: [], wed: [], thu: [], fri: [], sat: [], sun: []
        };
        let events = [];
        let currentUser = null;
        let activityLog = [];
        let selectedDays = [];

        // === GITHUB DATA LOADING (READ-ONLY - NO TOKEN NEEDED) ===
        async function loadDataFromGitHub() {
            console.log("Loading data from GitHub...");
            showSyncStatus("Loading data from GitHub...", "info");
            
            try {
                // Direct access to the raw data file - NO CORS ISSUES!
                const dataUrl = `https://raw.githubusercontent.com/${GITHUB_REPO}/main/${DATA_FILE_PATH}?t=${Date.now()}`;
                
                console.log("Fetching from:", dataUrl);
                const response = await fetch(dataUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log("Data loaded from GitHub:", data);
                
                // Update local data
                programmes = data.programmes || { mon: [], tue: [], wed: [], thu: [], fri: [], sat: [], sun: [] };
                events = data.events || [];
                
                showSyncStatus("Data loaded successfully from GitHub!", "success");
                logActivity('Data loaded from GitHub');
                return true;
                
            } catch (error) {
                console.error("Error loading from GitHub:", error);
                showSyncStatus("Error loading data: " + error.message, "error");
                logActivity('Error loading data from GitHub');
                return false;
            }
        }

        // === DATA MANAGEMENT (LOCAL STORAGE + CSV EXPORT) ===
        function saveDataToLocalStorage() {
            const data = {
                programmes: programmes,
                events: events,
                lastUpdated: new Date().toISOString(),
                updatedBy: currentUser
            };
            localStorage.setItem('calendarData', JSON.stringify(data));
            console.log("Data saved to local storage");
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('calendarData');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    programmes = data.programmes || { mon: [], tue: [], wed: [], thu: [], fri: [], sat: [], sun: [] };
                    events = data.events || [];
                    return true;
                } catch (error) {
                    console.error("Error loading saved data:", error);
                }
            }
            return false;
        }

        function exportToCSV() {
            let csvContent = "Type,Title,Description,Day,Date,Start Time,End Time,Days\n";
            
            Object.keys(programmes).forEach(day => {
                programmes[day].forEach(programme => {
                    const row = [
                        "Programme",
                        `"${programme.title}"`,
                        `"${programme.description}"`,
                        day,
                        "",
                        programme.startTime,
                        programme.endTime,
                        programme.days.join(',')
                    ];
                    csvContent += row.join(',') + '\n';
                });
            });
            
            events.forEach(event => {
                const row = [
                    "Event",
                    `"${event.title}"`,
                    `"${event.description}"`,
                    event.day,
                    event.date,
                    event.startTime,
                    event.endTime,
                    ""
                ];
                csvContent += row.join(',') + '\n';
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'programmes-events.csv';
            link.click();
            
            logActivity('Exported data to CSV');
            alert('CSV exported successfully! You can share this file with others.');
        }

        function showSyncStatus(message, type) {
            const statusElement = document.getElementById('sync-status');
            statusElement.textContent = message;
            statusElement.className = 'sync-status';
            
            if (type === 'success') {
                statusElement.classList.add('sync-success');
            } else if (type === 'error') {
                statusElement.classList.add('sync-error');
            }
            
            statusElement.style.display = 'block';
            
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 5000);
        }

        // === WORKFLOW FOR SHARING DATA ===
        function shareDataWithTeam() {
            exportToCSV();
            alert('CSV file downloaded! Share this file with your team via email, WhatsApp, or any file sharing method.');
        }

        function importDataFromCSV() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.csv';
            fileInput.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const csvText = e.target.result;
                        const rows = parseCSV(csvText);
                        
                        // Reset data
                        programmes = { mon: [], tue: [], wed: [], thu: [], fri: [], sat: [], sun: [] };
                        events = [];
                        
                        if (rows && rows.length > 0) {
                            console.log(`Found ${rows.length} rows in CSV`);
                            
                            rows.forEach((row, index) => {
                                // Skip header row
                                if (index === 0) return;
                                
                                const type = row[0] || '';
                                const title = row[1] || '';
                                const description = row[2] || '';
                                const day = (row[3] || '').toLowerCase();
                                const date = row[4] || '';
                                const startTime = row[5] || '';
                                const endTime = row[6] || '';
                                const days = row[7] || '';
                                
                                if (type === 'Programme' && title && day) {
                                    const programmeDays = days ? 
                                        days.split(',').map(d => d.trim().toLowerCase()) : 
                                        [day];
                                    
                                    programmeDays.forEach(progDay => {
                                        if (programmes[progDay] !== undefined) {
                                            programmes[progDay].push({
                                                title,
                                                description: description || '',
                                                startTime: startTime || '',
                                                endTime: endTime || '',
                                                days: programmeDays
                                            });
                                        }
                                    });
                                } else if (type === 'Event' && title) {
                                    events.push({
                                        title,
                                        description: description || '',
                                        date: date || '',
                                        startTime: startTime || '',
                                        endTime: endTime || '',
                                        day: day || ''
                                    });
                                }
                            });
                            
                            saveDataToLocalStorage();
                            showSyncStatus("CSV imported successfully!", "success");
                            logActivity('Imported data from CSV');
                            
                            // Refresh displays
                            if (document.getElementById('view').classList.contains('active')) {
                                displaySchedule(getCurrentDay());
                            }
                            if (document.getElementById('manage').classList.contains('active')) {
                                displayManageList();
                            }
                            
                            alert('CSV imported successfully! Data is now saved in this browser.');
                        }
                    } catch (error) {
                        console.error("Error importing CSV:", error);
                        showSyncStatus("Error importing CSV: " + error.message, "error");
                        alert('Error importing CSV file. Please check the format.');
                    }
                };
                reader.readAsText(file);
            };
            fileInput.click();
        }

        function parseCSV(csvText) {
            const rows = [];
            const lines = csvText.split('\n');
            
            lines.forEach(line => {
                if (line.trim() === '') return;
                
                const row = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        row.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                
                row.push(current.trim());
                rows.push(row);
            });
            
            return rows;
        }

        // Add CSV Import button to your action buttons
        function addCSVImportButton() {
            const actionButtons = document.querySelector('.action-buttons');
            const importButton = document.createElement('button');
            importButton.className = 'action-btn-large';
            importButton.innerHTML = '<i class="fas fa-upload"></i> Import CSV';
            importButton.onclick = importDataFromCSV;
            actionButtons.appendChild(importButton);
        }

        // [INCLUDE ALL YOUR EXISTING FUNCTIONS]
        // checkLogin(), displaySchedule(), displayManageList(), etc.
        // Keep all your existing calendar functionality

        // === INITIALIZATION ===
        function initializeCalendar() {
            // Add CSV import button
            addCSVImportButton();
            
            // Try to load from GitHub first, then fallback to local storage
            loadDataFromGitHub().then((githubSuccess) => {
                if (!githubSuccess) {
                    // If GitHub fails, try local storage
                    const localSuccess = loadFromLocalStorage();
                    if (localSuccess) {
                        showSyncStatus("Loaded from local storage", "info");
                    } else {
                        showSyncStatus("No data found - start adding programmes!", "info");
                    }
                }
                setupUI();
            });
        }

        // [KEEP ALL YOUR EXISTING setupUI() AND OTHER FUNCTIONS]

        // Update your form submissions to save locally
        document.getElementById('programme-form').addEventListener('submit', function(e) {
            e.preventDefault();
            // ... your existing code ...
            
            // Save to local storage instead of GitHub
            saveDataToLocalStorage();
            
            // ... rest of your code ...
        });

        // Start time updates
        updateSingaporeTime();
        setInterval(updateSingaporeTime, 1000);

        console.log("Calendar system ready - awaiting login");
    </script>
</body>
</html>