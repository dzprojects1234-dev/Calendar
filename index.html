function doGet(e) {
  try {
    const action = e.parameter.action;
    
    if (action === 'getData') {
      const sheet = SpreadsheetApp.openById('1lHJlL1yVtN96_pDbCK4kBJWl_6KFlWcqnifDhI69GmU').getSheetByName('Sheet1');
      const data = sheet.getDataRange().getValues();
      
      return ContentService.createTextOutput(JSON.stringify(data))
        .setMimeType(ContentService.MimeType.JSON)
        .setHeaders({
          'Access-Control-Allow-Origin': '*',
          'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
          'Access-Control-Allow-Headers': 'Content-Type'
        });
    }
    
    return ContentService.createTextOutput(JSON.stringify({success: false, error: 'Invalid action'}))
      .setMimeType(ContentService.MimeType.JSON)
      .setHeaders({
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
        'Access-Control-Allow-Headers': 'Content-Type'
      });
      
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({success: false, error: error.toString()}))
      .setMimeType(ContentService.MimeType.JSON)
      .setHeaders({
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
        'Access-Control-Allow-Headers': 'Content-Type'
      });
  }
}

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const action = data.action;
    const itemData = data.data;
    
    const sheet = SpreadsheetApp.openById('1lHJlL1yVtN96_pDbCK4kBJWl_6KFlWcqnifDhI69GmU').getSheetByName('Sheet1');
    
    if (action === 'add') {
      // Add new row
      const lastRow = sheet.getLastRow();
      const newRow = [
        itemData.type,
        itemData.title,
        itemData.description || '',
        itemData.day || '',
        itemData.date || '',
        itemData.startTime || '',
        itemData.endTime || '',
        itemData.days || ''
      ];
      
      sheet.getRange(lastRow + 1, 1, 1, newRow.length).setValues([newRow]);
      
      return ContentService.createTextOutput(JSON.stringify({success: true}))
        .setMimeType(ContentService.MimeType.JSON)
        .setHeaders({
          'Access-Control-Allow-Origin': '*',
          'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
          'Access-Control-Allow-Headers': 'Content-Type'
        });
        
    } else if (action === 'delete') {
      // Find and delete row
      const allData = sheet.getDataRange().getValues();
      
      for (let i = allData.length - 1; i >= 1; i--) { // Start from 1 to skip header
        const row = allData[i];
        if (row[0] === itemData.type && row[1] === itemData.title) {
          if ((itemData.type === 'Programme' && row[3] === itemData.day) || 
              (itemData.type === 'Event' && row[4] === itemData.date)) {
            sheet.deleteRow(i + 1);
            break;
          }
        }
      }
      
      return ContentService.createTextOutput(JSON.stringify({success: true}))
        .setMimeType(ContentService.MimeType.JSON)
        .setHeaders({
          'Access-Control-Allow-Origin': '*',
          'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
          'Access-Control-Allow-Headers': 'Content-Type'
        });
    }
    
    return ContentService.createTextOutput(JSON.stringify({success: false, error: 'Invalid action'}))
      .setMimeType(ContentService.MimeType.JSON)
      .setHeaders({
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
        'Access-Control-Allow-Headers': 'Content-Type'
      });
      
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({success: false, error: error.toString()}))
      .setMimeType(ContentService.MimeType.JSON)
      .setHeaders({
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
        'Access-Control-Allow-Headers': 'Content-Type'
      });
  }
}

function doOptions() {
  return ContentService.createTextOutput()
    .setHeaders({
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
      'Access-Control-Allow-Headers': 'Content-Type'
    });
}